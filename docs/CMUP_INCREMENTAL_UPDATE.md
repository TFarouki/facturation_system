# ุชุญุฏูุซ CMUP ุจุดูู ุชุฏุฑูุฌู (Incremental Update)

## ุงูุชุญุณูู

ุชู ุชุญุณูู ุญุณุงุจ CMUP ููุณุชุฎุฏู **ุงูุตูุบุฉ ุงูุชุฏุฑูุฌูุฉ** ุจุฏูุงู ูู ุฅุนุงุฏุฉ ุงูุญุณุงุจ ุงููุงูู ูู ุฌููุน ุงููุดุชุฑูุงุช. ูุฐุง ูุฌุนู ุงูุนูููุฉ ุฃุณุฑุน ุจูุซูุฑ.

## ุงูุตูุบุฉ ุงููุณุชุฎุฏูุฉ

ุนูุฏ ุฅุถุงูุฉ ูุดุชุฑูุงุช ุฌุฏูุฏุฉ:

```
CMUP ุงูุฌุฏูุฏ = ((ูุฎุฒูู ุงูููุชุฌ ร CMUP ุงููุฏูู) + (ุณุนุฑ ุงูุดุฑุงุก ุงูุฌุฏูุฏ ร ุงููููุฉ ุงูุฌุฏูุฏุฉ)) / (ูุฎุฒูู ุงูููุชุฌ + ุงููููุฉ ุงูุฌุฏูุฏุฉ)
```

ุฃู ุจุงูุตูุบุฉ ุงูุฑูุงุถูุฉ:

```
New CMUP = ((Old Stock ร Old CMUP) + (New Price ร New Quantity)) / (Old Stock + New Quantity)
```

ุญูุซ:
- **Old Stock** = ุงููุฎุฒูู ุงูุญุงูู ูุจู ุฅุถุงูุฉ ุงูุดุฑุงุก ุงูุฌุฏูุฏ
- **Old CMUP** = ูููุฉ CMUP ุงูุญุงููุฉ
- **New Price** = ุณุนุฑ ุงูุดุฑุงุก ุงูุฌุฏูุฏ
- **New Quantity** = ุงููููุฉ ุงููุดุชุฑุงุฉ ุงูุฌุฏูุฏุฉ

## ูุชู ูุชู ุงุณุชุฎุฏุงู ุงูุชุญุณูู ุงูุชุฏุฑูุฌู

### โ ุนูุฏ ุฅุถุงูุฉ ูุงุชูุฑุฉ ุฌุฏูุฏุฉ:

```php
// 1. ุฅุถุงูุฉ ุชูุงุตูู ุงููุดุชุฑูุงุช
PurchaseDetail::create([...]);

// 2. ุชุญุฏูุซ CMUP ุชุฏุฑูุฌูุงู (ูุณุชุฎุฏู ุงููุฎุฒูู ุงูุญุงูู)
$cmupCalculator->updateCmupIncremental($product, $quantity, $price);

// 3. ุชุญุฏูุซ ุงููุฎุฒูู
$product->increment('current_stock_quantity', $quantity);
```

### โ ุนูุฏ ุชุญุฏูุซ ูุงุชูุฑุฉ:

```php
// 1. ุฅุฑุฌุงุน ุงููุฎุฒูู ููููู ุงููุฏููุฉ
$product->decrement('current_stock_quantity', $oldQuantity);

// 2. ุญุฐู ุงูุชูุงุตูู ุงููุฏููุฉ
$purchase->details()->delete();

// 3. ุฅุนุงุฏุฉ ุญุณุงุจ CMUP (ุจุนุฏ ุฅุฒุงูุฉ ุงููุฏูู)
$cmupCalculator->updateCmup($product);

// 4. ุฅุถุงูุฉ ุงูุชูุงุตูู ุงูุฌุฏูุฏุฉ
PurchaseDetail::create([...]);

// 5. ุชุญุฏูุซ CMUP ุชุฏุฑูุฌูุงู
$cmupCalculator->updateCmupIncremental($product, $newQuantity, $newPrice);

// 6. ุชุญุฏูุซ ุงููุฎุฒูู
$product->increment('current_stock_quantity', $newQuantity);
```

### โ ุนูุฏ ุญุฐู ูุงุชูุฑุฉ:

```php
// 1. ุฅุฑุฌุงุน ุงููุฎุฒูู
$product->decrement('current_stock_quantity', $quantity);

// 2. ุญุฐู ุงูุชูุงุตูู ูุงููุงุชูุฑุฉ
$purchase->details()->delete();
$purchase->delete();

// 3. ุฅุนุงุฏุฉ ุญุณุงุจ CMUP ูู ุฌููุน ุงููุดุชุฑูุงุช ุงููุชุจููุฉ
$cmupCalculator->updateCmup($product);
```

## ูุซุงู ุนููู

### ูุซุงู: ุฅุถุงูุฉ ูุงุชูุฑุฉ ุฌุฏูุฏุฉ

**ุงูููุชุฌ ุงูุญุงูู:**
- ุงููุฎุฒูู: 10 ูุทุน
- CMUP: 50 DH

**ูุงุชูุฑุฉ ุฌุฏูุฏุฉ:**
- 5 ูุทุน ร 60 DH

**ุงูุญุณุงุจ:**
```
CMUP ุงูุฌุฏูุฏ = ((10 ร 50) + (5 ร 60)) / (10 + 5)
            = (500 + 300) / 15
            = 800 / 15
            = 53.33 DH
```

**ุจุนุฏ ุงูุฅุถุงูุฉ:**
- ุงููุฎุฒูู: 15 ูุทุนุฉ
- CMUP: 53.33 DH

## ุงููููุฒุงุช

1. โก **ุฃุณุฑุน ุจูุซูุฑ**: ูุง ูุญุชุงุฌ ูุงุณุชุญุถุงุฑ ุฌููุน ุงููุดุชุฑูุงุช
2. ๐ฏ **ุฏููู**: ูุนุทู ููุณ ุงููุชูุฌุฉ ูุฅุนุงุฏุฉ ุงูุญุณุงุจ ุงููุงูู
3. ๐ช **ููุงุกุฉ**: ููุงุณุจ ููููุชุฌุงุช ุฐุงุช ุงููุดุชุฑูุงุช ุงููุซูุฑุฉ

## ุงูุญุงูุงุช ุงูุฎุงุตุฉ

### ุฅุฐุง ูุงู ุงููุฎุฒูู = 0:

```php
if ($oldStock <= 0) {
    $newCmup = $newPrice; // CMUP = ุณุนุฑ ุงูุดุฑุงุก ุงูุฌุฏูุฏ ูุจุงุดุฑุฉ
}
```

### ุนูุฏ ุญุฐู/ุชุญุฏูุซ ูุงุชูุฑุฉ:

ูุชู ุฅุนุงุฏุฉ ุงูุญุณุงุจ ุงููุงูู ูุถูุงู ุงูุฏูุฉ ุงูุชุงูุฉ.


